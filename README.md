# Docker Compose NGINX with self-renewing Let's Encrypt HTTPS Easy
Docker is supposed to make server deployment easy, but without the right recipe, some things may become much harder. Running an NGINX server with HTTPS via Let's Encrypt, along with auto-renewal, was one such SNAFU. Having found existing recipes on the internet for this unnecessarily complex or unreliable, I am sharing my solution designed to eliminate headaches associated with this.

## Enough talk. Let's go!
```
git clone https://github.com/colinbrogan/nginx_https_easy_docker
```
Change DOMAIN in the .env file to your domain. 

### Setup a docker node with a hosting provider
[DigitalOcean](hosting_providers/digitalocean.md)


#### Deploy!
```
docker compose up --build -d
```

Watch your domain magically become HTTPS, and worry not about renewals.


## Why?
While docker in theory simplifies server setup and management, in practice it's seperation of services can make Let's Encrypt + Nginx configuration complex. Getting docker to create the certificate and configure NGINX is one thing. To then have it autorenew (so your clients' website doesn't go down in 3 months) is quite another accomplishment. Docker is designed for each service to run a single primary process, so we have to come up with entrypoints to coordinate the two services (nginx and certbot), waiting for each eachother to do a task before progressing to a final stages. Luckily, I've done this already for you.

## How?
We have two seperate configurations files for NGINX `nginx/precert.conf`, and `nginx/cert.conf`. precert.conf is designed to run NGINX only on port 80 (http), so that cerbot can perform it's acme challenge. We do this because NGINX would exit with an error if we configured it for HTTPS before getting the certificate generated by acme challenge. We have to switch to the full configuration of NGINX (cert.conf) later. cert.conf is also where you would add any custom nginx configuration for your particular project.

Observe the nginx services' entrypoint `nginx/cert-entrypoint.sh`. We first overwrite all nginx configuration files with the domain defined in .env. We then run an infinite while loop in the background which checks if the cert files exist every 10 seconds, before moving to the primary process of running nginx (which at this point will be running cert.conf configuration). This gets us up on port 80, waiting for the certbot service to do it's acme test. As soon as the file check observes the certificate exists (certbot completed the acme test), we then switch the nginx configuration file to cert.conf, which is the full configuration for your site employeing the https certificates, and reload nginx. We now switch the while loop wait time of every 10 seconds to evert 6 hours, since we now only need to reload nginx when certbot renews the certificate.

Moving to certbot's entrypoint `certbot/certbot-entrypoint.sh`, we see another file looking for the existence of the certificate. If it's not there, we generate them into the volume which is shared between nginx and certbot. We then enter an infinite loop to renew the certificate (whether pre-existing or newly generated) every 12 hours.


## Conclusion
I have yet to see a solution for NGINX and let's encrypt which manages both initial certificate generation and auto-renewal without performing atleast some of the steps manually. By creating a compose file which automatically generates and/or renews at docker's build / runtime, you can focus your efforts on your app without annoying server setup / maintenance, which is what docker was designed to do in the first place!